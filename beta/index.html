<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบบันทึกเวลาด้วยใบหน้า</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    video::-webkit-media-controls { display: none !important; }
    .modal-overlay { transition: opacity .3s ease; }
    .modal-content { transition: transform .3s ease; }
    #video-container, #clock-video-container {
      position: relative; width: 100%; max-width: 448px; margin:auto;
      background:#E5E7EB; border-radius:.5rem; overflow:hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,.06);
    }
    #video, #clock-video { width:100%; height:auto; }
    #clock-canvas { position:absolute; top:0; left:0; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4 md:p-8 max-w-6xl">
    <header class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-700">ระบบบันทึกเวลาด้วยใบหน้า</h1>
      <p class="text-gray-500 mt-2">เวอร์ชัน 5.7 – ฉบับปรับปรุง</p>
    </header>

    <div class="mb-6 border-b border-gray-200">
      <nav class="flex space-x-4" aria-label="Tabs">
        <button id="tab-clock" class="tab-button text-indigo-600 border-b-2 border-indigo-500 px-3 py-2 font-medium text-sm rounded-t-md">ลงเวลา</button>
        <button id="tab-register" class="tab-button text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md">ลงทะเบียน</button>
        <button id="tab-history" class="tab-button text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md">ประวัติ</button>
      </nav>
    </div>

    <main>
      <div id="content-clock" class="tab-content p-4 md:p-6 bg-white rounded-lg shadow">
        <div id="clock-loader" class="text-center py-8">
          <p class="text-lg font-medium text-indigo-600">กำลังเตรียมระบบลงเวลา...</p>
        </div>

        <div id="clock-container" class="hidden grid md:grid-cols-2 gap-8 items-start">
          <div class="flex flex-col h-full">
             <div class="flex-grow text-center">
                <div id="clock-video-container">
                    <video id="clock-video" width="640" height="480" autoplay muted playsinline></video>
                    <canvas id="clock-canvas"></canvas>
                </div>
                <p id="clock-status" class="mt-4 text-lg font-semibold h-8"></p>
                <p id="clock-time" class="text-4xl font-bold text-gray-800 my-4"></p>
             </div>
             <div class="mt-4 md:mt-auto p-4 bg-gray-50 rounded-b-lg">
                <button id="clock-action-button" disabled class="w-full max-w-xs mx-auto inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 hidden">
                  กรุณามองกล้องเพื่อสแกนใบหน้า
                </button>
                <div class="mt-4 text-center">
                    <button id="pin-fallback-button" class="text-sm text-indigo-600 hover:underline">มีปัญหา? ใช้รหัส PIN</button>
                </div>
            </div>
          </div>
          <div>
            <h2 class="text-lg font-semibold text-gray-800 mb-4">5 รายการล่าสุด</h2>
            <div id="recent-attendance-list" class="space-y-2 bg-gray-50 p-3 rounded-lg border min-h-[300px]"></div>
          </div>
        </div>

        <div id="confirmation-screen" class="hidden text-center p-8">
            <h2 class="text-2xl font-bold text-gray-800">ยืนยันการลงเวลา</h2>
            <p id="confirm-user-name" class="my-4 text-xl font-medium"></p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="confirm-in-button" class="w-full sm:w-auto inline-flex justify-center bg-green-600 text-white py-4 px-8 rounded-lg text-lg font-bold hover:bg-green-700">
                บันทึกเวลาเข้า
                </button>
                <button id="confirm-out-button" class="w-full sm:w-auto inline-flex justify-center bg-red-600 text-white py-4 px-8 rounded-lg text-lg font-bold hover:bg-red-700">
                บันทึกเวลาออก
                </button>
            </div>
            <button id="confirm-cancel-button" class="mt-6 text-sm text-gray-500 hover:underline">ยกเลิก</button>
        </div>

        <div id="success-screen" class="hidden text-center py-20">
            <svg class="mx-auto h-24 w-24 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 id="success-message" class="mt-4 text-2xl font-bold text-gray-800"></h2>
            <p class="text-gray-500">ระบบจะกลับสู่หน้าหลักใน 5 วินาที</p>
        </div>

        <div id="pin-container" class="hidden max-w-sm mx-auto mt-6">
          <h3 class="text-center font-semibold mb-4">ลงเวลาด้วยรหัส PIN</h3>
          <div class="space-y-4">
            <div>
              <label for="pin-employeeId" class="block text-sm font-medium">รหัสพนักงาน</label>
              <input type="text" id="pin-employeeId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <div>
              <label for="pin-code" class="block text-sm font-medium">รหัส PIN</label>
              <input type="password" id="pin-code" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <button id="pin-submit-button" class="w-full inline-flex justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">ยืนยัน</button>
            <button id="pin-cancel-button" class="w-full inline-flex justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">ยกเลิก</button>
          </div>
        </div>
      </div>

      <div id="content-register" class="tab-content hidden p-4 md:p-6 bg-white rounded-lg shadow">
        </div>

      <div id="content-history" class="tab-content hidden p-4 md:p-6 bg-white rounded-lg shadow">
        </div>
    </main>
  </div>
  
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCxhLq7q5M6OQsVxgytFi7vSu8fOrV_yVo",
      authDomain: "face-attendance-app-7231d.firebaseapp.com",
      projectId: "face-attendance-app-7231d",
      storageBucket: "face-attendance-app-7231d.firebasestorage.app",
      messagingSenderId: "374495265979",
      appId: "1:374495265979:web:edd70449d0b378eeec959e"
    };
    const appId = 'face-attendance-app';

    // --- Firebase Init ---
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // --- Global State & Elements ---
    let currentTab = 'clock'; // V5.7: เริ่มต้นที่หน้าลงเวลา
    let faceMatcher = null;
    let registeredUsersData = [];
    let recognitionInterval = null;
    const lastScanTimestamps = {};
    const SCAN_COOLDOWN_SECONDS = 10; // ลดเวลา Cooldown ลง

    // --- Clock Tab Elements ---
    const clockLoader = document.getElementById('clock-loader');
    const clockContainer = document.getElementById('clock-container');
    const clockVideo = document.getElementById('clock-video');
    const clockCanvas = document.getElementById('clock-canvas');
    const clockStatus = document.getElementById('clock-status');
    const clockTime = document.getElementById('clock-time');
    const recentAttendanceList = document.getElementById('recent-attendance-list');
    
    // V5.7: Element ใหม่สำหรับหน้าจอต่างๆ
    const confirmationScreen = document.getElementById('confirmation-screen');
    const confirmUserName = document.getElementById('confirm-user-name');
    const confirmInButton = document.getElementById('confirm-in-button');
    const confirmOutButton = document.getElementById('confirm-out-button');
    const confirmCancelButton = document.getElementById('confirm-cancel-button');
    const successScreen = document.getElementById('success-screen');
    const successMessage = document.getElementById('success-message');

    let userToConfirm = null;
    let recognizedUserId = null;
    let recognitionTimeout = null;
    const CONFIRMATION_TIME = 2000; // 2 วินาที

    // --- ... (ส่วน Register และ History Elements เหมือนเดิม) ... ---

    // --- UI helpers ---
    // ... (ส่วน Modal helpers เหมือนเดิม) ...

    function showSuccessScreen(user, type) {
        const typeText = type === 'IN' ? 'เข้างาน' : 'ออกงาน';
        successMessage.textContent = `คุณ ${user.name} บันทึกเวลา${typeText}สำเร็จ!`;
        clockContainer.classList.add('hidden');
        confirmationScreen.classList.add('hidden');
        successScreen.classList.remove('hidden');

        setTimeout(() => {
            successScreen.classList.add('hidden');
            clockContainer.classList.remove('hidden');
            resetClockFlow();
        }, 5000);
    }
    
    function resetClockFlow() {
        userToConfirm = null;
        recognizedUserId = null;
        clearTimeout(recognitionTimeout);
        clockStatus.textContent = '';
        confirmationScreen.classList.add('hidden');
        clockContainer.classList.remove('hidden');
    }

    function updateClock() {
      clockTime.textContent = new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }

    // --- Tabs ---
    // ... (ส่วน Tabs switching เหมือนเดิม, แต่จัดการ start/stop recognition ต่างไป) ...
    function switchTab(tabName){
        currentTab = tabName;
        // ... (โค้ดสลับ class ของปุ่มเหมือนเดิม) ...

        if (tabName === 'clock'){
            stopWebcam(video); // ปิดกล้องหน้า Register (ถ้าเปิดอยู่)
            startWebcam(clockVideo, () => {
                if (!recognitionInterval) startRecognition();
            });
            resetClockFlow();
        } else {
            stopRecognition();
            stopWebcam(clockVideo);
            if(tabName === 'register') startWebcam(video);
            if(tabName === 'history') fetchHistory();
        }
    }

    // --- Face-API model loading (เหมือนเดิม) ---
    // ...

    // --- Webcam (เหมือนเดิม) ---
    // ...

    // --- Face Recognition (V5.7: ปรับปรุงใหม่ทั้งหมด) ---
    async function loadRegisteredUsersForRecognition(){
      // ... (เหมือนเดิม) ...
    }

    function startRecognition() {
        if (recognitionInterval || !faceMatcher) return;
        
        clockLoader.classList.add('hidden');
        clockContainer.classList.remove('hidden');

        recognitionInterval = setInterval(async () => {
            if (currentTab !== 'clock' || !successScreen.classList.contains('hidden') || !confirmationScreen.classList.contains('hidden')) {
                return;
            }

            const detections = await faceapi
                .detectAllFaces(clockVideo, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
                .withFaceLandmarks()
                .withFaceDescriptors();
            
            // วาดกรอบบนใบหน้า
            const displaySize = { width: clockVideo.clientWidth, height: clockVideo.clientHeight };
            faceapi.matchDimensions(clockCanvas, displaySize);
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            clockCanvas.getContext('2d').clearRect(0, 0, clockCanvas.width, clockCanvas.height);
            faceapi.draw.drawDetections(clockCanvas, resizedDetections);

            if (detections.length > 0) {
                const bestMatch = faceMatcher.findBestMatch(detections[0].descriptor);

                if (bestMatch.label !== 'unknown') {
                    if (bestMatch.label !== recognizedUserId) {
                        clearTimeout(recognitionTimeout);
                        recognizedUserId = bestMatch.label;
                        userToConfirm = registeredUsersData.find(u => u.id === recognizedUserId);
                        
                        if (userToConfirm) {
                            clockStatus.textContent = `ตรวจพบ ${userToConfirm.name}, กรุณามองกล้องค้างไว้...`;
                            
                            recognitionTimeout = setTimeout(() => {
                                if (userToConfirm) {
                                    clockContainer.classList.add('hidden');
                                    confirmUserName.textContent = `คุณ ${userToConfirm.name}`;
                                    confirmationScreen.classList.remove('hidden');
                                }
                            }, CONFIRMATION_TIME);
                        }
                    }
                } else {
                    clearTimeout(recognitionTimeout);
                    recognizedUserId = null;
                    userToConfirm = null;
                    clockStatus.textContent = '';
                }
            } else {
                clearTimeout(recognitionTimeout);
                recognizedUserId = null;
                userToConfirm = null;
                clockStatus.textContent = '';
            }
        }, 500); // สแกนเร็วขึ้นเล็กน้อย
    }

    function stopRecognition() {
        if (recognitionInterval) {
            clearInterval(recognitionInterval);
            recognitionInterval = null;
        }
        clearTimeout(recognitionTimeout);
        recognizedUserId = null;
        userToConfirm = null;
    }

    // V5.7: ฟังก์ชันใหม่สำหรับการบันทึกหลังกดยืนยัน
    async function finalizeAttendance(user, type) {
        const now = new Date();
        const lastScan = lastScanTimestamps[user.id];
        if (lastScan && (now - lastScan) / 1000 < SCAN_COOLDOWN_SECONDS) {
            showModal('สแกนซ้ำ', `กรุณารอ ${SCAN_COOLDOWN_SECONDS} วินาทีเพื่อทำรายการอีกครั้ง`, true);
            resetClockFlow();
            return;
        }

        try {
            await setDoc(doc(collection(db, `artifacts/${appId}/public/data/attendance`)), {
                employeeId: user.id,
                employeeName: user.name,
                timestamp: now,
                type: type, // 'IN' or 'OUT' from button
                method: 'Face_Confirm'
            });

            lastScanTimestamps[user.id] = now;
            showSuccessScreen(user, type);
            await fetchRecentAttendance();

        } catch (err) {
            console.error('Error finalizing attendance:', err);
            showModal('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกเวลาได้', true);
            resetClockFlow();
        }
    }
    
    confirmInButton.addEventListener('click', () => {
        if (userToConfirm) finalizeAttendance(userToConfirm, 'IN');
    });

    confirmOutButton.addEventListener('click', () => {
        if (userToConfirm) finalizeAttendance(userToConfirm, 'OUT');
    });

    confirmCancelButton.addEventListener('click', () => {
        resetClockFlow();
    });

    async function fetchRecentAttendance(){
        // ... (เหมือนเดิม) ...
    }
    
    // --- PIN fallback (เหมือนเดิม) ---
    // ... (ฟังก์ชัน showPinForm, pin fallback buttons, pin submit button) ...

    // --- Register flow (เหมือนเดิม) ---
    // ... (ฟังก์ชันและ event listeners ทั้งหมดของหน้า Register) ...

    // --- History (เหมือนเดิม) ---
    // ... (ฟังก์ชันและ event listeners ทั้งหมดของหน้า History) ...

    // --- App bootstrap ---
    async function main() {
        try {
            await signInAnonymously(auth);
            const modelsLoaded = await loadModels();
            if (modelsLoaded) {
                await Promise.all([fetchRegisteredUsers(), loadRegisteredUsersForRecognition(), fetchRecentAttendance()]);
                loader.classList.add('hidden');
                registerFormContainer.classList.remove('hidden');
                historyDateInput.value = new Date().toISOString().split('T')[0];
                
                // V5.7: เริ่มต้นที่หน้าลงเวลา
                switchTab('clock'); 
                
                setInterval(updateClock, 1000);
            }
        } catch(err) {
            console.error('Initialization failed:', err);
            loader.innerHTML = '<p class="text-red-500">เกิดข้อผิดพลาดในการเริ่มต้นระบบ</p>';
        }
    }
    main();
  </script>
</body>
</html>
