<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบบันทึกเวลาด้วยใบหน้า</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    video::-webkit-media-controls { display: none !important; }
    .modal-overlay { transition: opacity .3s ease; }
    .modal-content { transition: transform .3s ease; }
    #video-container, #clock-video-container { position:relative; width:100%; max-width:448px; margin:auto; background:#E5E7EB; border-radius:.5rem; overflow:hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,.06); }
    #video, #clock-video, #reg-canvas, #clock-canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
    #video { transform: scaleX(-1); }
    #clock-video { transform: scaleX(-1); }
    #reg-canvas, #clock-canvas { pointer-events:none; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4 md:p-8 max-w-6xl">
    <header class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-700">ระบบบันทึกเวลาด้วยใบหน้า</h1>
      <p class="text-gray-500 mt-2">เวอร์ชัน 5.6 – First working build</p>
    </header>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200">
      <nav class="flex space-x-4" aria-label="Tabs">
        <button id="tab-clock" class="tab-button text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md">ลงเวลา</button>
        <button id="tab-register" class="tab-button text-indigo-600 hover:text-indigo-700 px-3 py-2 font-medium text-sm rounded-t-md">ลงทะเบียน</button>
        <button id="tab-history" class="tab-button text-gray-500 hover:text-gray-700 px-3 py-2 font-medium text-sm rounded-t-md">ประวัติ</button>
      </nav>
    </div>

    <main>
      <!-- Clock -->
      <div id="content-clock" class="tab-content hidden p-4 md:p-6 bg-white rounded-lg shadow">
        <div id="clock-loader" class="text-center py-8">
          <p class="text-lg font-medium text-indigo-600">กำลังเตรียมระบบลงเวลา...</p>
        </div>

        <div id="clock-container" class="hidden grid md:grid-cols-2 gap-8 items-start">
          <div class="text-center">
            <div id="clock-video-container">
              <video id="clock-video" width="640" height="480" autoplay muted playsinline></video>
              <canvas id="clock-canvas"></canvas>
            </div>
            <p id="clock-status" class="mt-4 text-lg font-semibold h-8"></p>
            <p id="clock-time" class="text-4xl font-bold text-gray-800 my-4"></p>
            <button id="clock-action-button" disabled class="w-full inline-flex justify-center py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400">
              กรุณามองกล้องเพื่อสแกนใบหน้า
            </button>
            <div class="mt-4">
              <button id="pin-fallback-button" class="text-sm text-indigo-600 hover:underline">สแกนหน้าไม่ผ่าน? ใช้รหัส PIN</button>
            </div>
          </div>
          <div>
            <h2 class="text-lg font-semibold text-gray-800 mb-4">5 รายการล่าสุด</h2>
            <div id="recent-attendance-list" class="space-y-2 bg-gray-50 p-3 rounded-lg border min-h-[300px]"></div>
          </div>
        </div>

        <!-- PIN -->
        <div id="pin-container" class="hidden max-w-sm mx-auto mt-6">
          <h3 class="text-center font-semibold mb-4">ลงเวลาด้วยรหัส PIN</h3>
          <div class="space-y-4">
            <div>
              <label for="pin-employeeId" class="block text-sm font-medium">รหัสพนักงาน</label>
              <input type="text" id="pin-employeeId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <div>
              <label for="pin-code" class="block text-sm font-medium">รหัส PIN</label>
              <input type="password" id="pin-code" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <button id="pin-submit-button" class="w-full inline-flex justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">ยืนยัน</button>
            <button id="pin-cancel-button" class="w-full inline-flex justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">ยกเลิก</button>
          </div>
        </div>

        <!-- Mobile bottom bar (added in v5.7) -->
        <div id="clock-bottom-bar" class="fixed bottom-0 inset-x-0 md:hidden bg-white/90 backdrop-blur border-t border-gray-200 px-4 py-3 z-40">
          <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
            <div class="text-sm font-medium text-gray-700"><span class="hidden xs:inline">สแกนอัตโนมัติ</span></div>
            <div class="flex items-center gap-2">
              <button id="pin-fallback-button-mobile" class="px-4 py-2 rounded-lg border text-sm font-semibold text-indigo-700 border-indigo-200 bg-indigo-50">ใช้รหัส PIN</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Register -->
      <div id="content-register" class="tab-content p-4 md:p-6 bg-white rounded-lg shadow">
        <div id="loader" class="text-center py-8">
          <p class="text-lg font-medium text-indigo-600">กำลังเตรียมระบบลงทะเบียน...</p>
        </div>

        <div id="register-form-container" class="hidden grid md:grid-cols-2 gap-8 items-start">
          <div>
            <div id="video-container">
              <video id="video" width="640" height="480" autoplay muted playsinline></video>
              <canvas id="reg-canvas"></canvas>
            </div>
            <p id="status-message" class="mt-4 text-center h-6 text-gray-700"></p>
            <div class="flex items-center justify-center gap-3 mt-4">
              <button id="capture-button" disabled class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">เริ่มขั้นตอนลงทะเบียน</button>
              <span class="text-sm text-gray-500">(ต้องเห็นใบหน้าชัดเจน)</span>
            </div>
            <div id="thumbnails-container" class="mt-4 grid grid-cols-3 gap-2"></div>
          </div>

          <div>
            <div class="bg-white p-4 rounded-lg border">
              <h2 class="text-lg font-semibold text-gray-800">ข้อมูลพนักงาน</h2>
              <div class="mt-4 space-y-3">
                <div>
                  <label for="employee-id" class="block text-sm font-medium">รหัสพนักงาน</label>
                  <input type="text" id="employee-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                  <label for="employee-name" class="block text-sm font-medium">ชื่อ-นามสกุล</label>
                  <input type="text" id="employee-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                  <label for="employee-pin" class="block text-sm font-medium">กำหนด PIN (4–6 หลัก)</label>
                  <input type="password" id="employee-pin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <button id="save-button" class="w-full inline-flex justify-center py-2 px-4 border shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">บันทึกข้อมูล</button>
              </div>
            </div>

            <div class="mt-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-3">รายชื่อพนักงาน</h3>
              <div id="user-list" class="space-y-2 max-h-[360px] overflow-auto border rounded-lg p-2 bg-gray-50"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- History -->
      <div id="content-history" class="tab-content hidden p-4 md:p-6 bg-white rounded-lg shadow">
        <div class="mb-4 flex flex-col md:flex-row gap-3 items-center">
          <input id="history-date" type="date" class="px-3 py-2 border rounded-md">
          <input id="history-search" type="text" placeholder="ค้นหาชื่อหรือรหัสพนักงาน" class="flex-1 px-3 py-2 border rounded-md w-full">
          <button id="export-csv-button" class="px-4 py-2 rounded-md text-sm text-white bg-indigo-600 hover:bg-indigo-700">Export CSV</button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">พนักงาน</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">วันที่</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">เข้า</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ออก</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ชั่วโมง</th>
              </tr>
            </thead>
            <tbody id="history-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
          <div id="history-no-data" class="hidden text-center text-gray-500 py-6">ไม่พบข้อมูล</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal (info) -->
  <div id="modal" class="modal-overlay fixed inset-0 bg-black/50 opacity-0 pointer-events-none flex items-center justify-center p-4">
    <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 id="modal-title" class="text-lg font-medium text-gray-900">ข้อความ</h3>
      <div id="modal-message" class="mt-2 text-sm text-gray-700"></div>
      <div class="mt-4 flex justify-end">
        <button id="modal-close" class="px-4 py-2 text-white bg-indigo-600 rounded-md">ปิด</button>
      </div>
    </div>
  </div>

  <!-- Confirm delete modal -->
  <div id="confirm-modal" class="modal-overlay fixed inset-0 bg-black/50 opacity-0 pointer-events-none flex items-center justify-center p-4">
    <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 class="text-lg font-medium text-gray-900">ยืนยันการลบ</h3>
      <div id="confirm-modal-message" class="mt-2 text-sm text-gray-700"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="confirm-modal-cancel" class="px-4 py-2 rounded-md border">ยกเลิก</button>
        <button id="confirm-modal-delete" class="px-4 py-2 rounded-md bg-red-600 text-white">ลบ</button>
      </div>
    </div>
  </div>

  <!-- Confirm & Success overlays (added in v5.7) -->
  <!-- Confirm Overlay -->
  <div id="confirm-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center">
      <h3 class="text-xl font-bold text-gray-800 mb-2">ยืนยันตัวตน</h3>
      <p id="confirm-name" class="text-lg text-gray-700 mb-6">-</p>
      <div class="grid grid-cols-2 gap-3">
        <button id="confirm-in" class="inline-flex justify-center items-center px-4 py-3 rounded-lg text-white bg-green-600 hover:bg-green-700 font-semibold">ยืนยันเข้างาน</button>
        <button id="confirm-out" class="inline-flex justify-center items-center px-4 py-3 rounded-lg text-white bg-amber-600 hover:bg-amber-700 font-semibold">ยืนยันออกงาน</button>
      </div>
    </div>
  </div>

  <!-- Success Overlay -->
  <div id="success-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center">
      <div class="text-6xl mb-3">✔</div>
      <h3 id="success-text" class="text-xl font-bold text-gray-800">บันทึกสำเร็จ</h3>
      <p class="text-gray-500 mt-2">กำลังกลับสู่หน้าสแกนอัตโนมัติ...</p>
    </div>
  </div>

  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- Firebase Config (UPDATED) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAzcUm26W9PdhiPpj0ivemX91MF_iEdMg8",
      authDomain: "face-attendance-app-d439d.firebaseapp.com",
      projectId: "face-attendance-app-d439d",
      storageBucket: "face-attendance-app-d439d.firebasestorage.app",
      messagingSenderId: "462584831921",
      appId: "1:462584831921:web:b1cbb6b7274533ce31e790"
    };

    // --- App Context ---
    const appId = 'default';
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- Global State & Elements ---
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalClose = document.getElementById('modal-close');

    const confirmModal = document.getElementById('confirm-modal');
    const confirmModalMessage = document.getElementById('confirm-modal-message');
    const confirmModalCancel = document.getElementById('confirm-modal-cancel');
    const confirmModalDelete = document.getElementById('confirm-modal-delete');

    const tabs = { clock: document.getElementById('tab-clock'), register: document.getElementById('tab-register'), history: document.getElementById('tab-history') };
    const contents = { clock: document.getElementById('content-clock'), register: document.getElementById('content-register'), history: document.getElementById('content-history') };

    let currentTab = 'clock';
    let faceMatcher = null;
    let registeredUsersData = [];
    let recognitionInterval = null;
    const lastScanTimestamps = {};
    const SCAN_COOLDOWN_SECONDS = 30;
    let userToDeleteId = null;

    // --- Auto-confirm state (added in v5.7) ---
    let confirmMode = false;
    let stableMatchSince = 0;
    let lastMatchId = null;
    let confirmCandidate = null;
    const AUTO_HOLD_MS = 2000; // 2s stable hold

    // Overlays & mobile bottom bar elements
    const confirmOverlay = document.getElementById('confirm-overlay');
    const confirmName = document.getElementById('confirm-name');
    const confirmInBtn = document.getElementById('confirm-in');
    const confirmOutBtn = document.getElementById('confirm-out');
    const successOverlay = document.getElementById('success-overlay');
    const successText = document.getElementById('success-text');
    const pinFallbackButtonMobile = document.getElementById('pin-fallback-button-mobile');
    if (pinFallbackButtonMobile) pinFallbackButtonMobile.addEventListener('click', ()=> pinFallbackButton.click());

    // --- Clock Tab Elements ---
    const clockLoader = document.getElementById('clock-loader');
    const clockContainer = document.getElementById('clock-container');
    const clockVideo = document.getElementById('clock-video');
    const clockCanvas = document.getElementById('clock-canvas');
    const clockStatus = document.getElementById('clock-status');
    const clockTime = document.getElementById('clock-time');
    const clockActionButton = document.getElementById('clock-action-button');
    const pinFallbackButton = document.getElementById('pin-fallback-button');
    const pinContainer = document.getElementById('pin-container');
    const pinEmployeeIdInput = document.getElementById('pin-employeeId');
    const pinCodeInput = document.getElementById('pin-code');
    const pinSubmitButton = document.getElementById('pin-submit-button');
    const pinCancelButton = document.getElementById('pin-cancel-button');
    const recentAttendanceList = document.getElementById('recent-attendance-list');
    let activeUser = null;

    // --- Register Tab Elements ---
    const loader = document.getElementById('loader');
    const registerFormContainer = document.getElementById('register-form-container');
    const video = document.getElementById('video');
    const regCanvas = document.getElementById('reg-canvas');
    const statusMessage = document.getElementById('status-message');
    const thumbnailsContainer = document.getElementById('thumbnails-container');
    const employeeIdInput = document.getElementById('employee-id');
    const employeeNameInput = document.getElementById('employee-name');
    const employeePinInput = document.getElementById('employee-pin');
    const captureButton = document.getElementById('capture-button');
    const saveButton = document.getElementById('save-button');
    const userList = document.getElementById('user-list');

    // --- History Elements ---
    const historyDateInput = document.getElementById('history-date');
    const historySearchInput = document.getElementById('history-search');
    const historyTableBody = document.getElementById('history-table-body');
    const historyNoData = document.getElementById('history-no-data');
    const exportCsvButton = document.getElementById('export-csv-button');
    let fullHistoryData = [];

    // --- UI helpers ---
    function showModal(title, message, isError = false) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalTitle.className = isError ? 'text-lg font-medium text-red-700' : 'text-lg font-medium text-gray-900';
      modal.classList.remove('opacity-0','pointer-events-none');
      modal.querySelector('.modal-content').classList.remove('scale-95');
    }
    modalClose.addEventListener('click', () => {
      modal.classList.add('opacity-0','pointer-events-none');
      modal.querySelector('.modal-content').classList.add('scale-95');
    });

    function showConfirmModal(id, name) {
      userToDeleteId = id;
      confirmModalMessage.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบพนักงาน: ${name} (ID: ${id})? การกระทำนี้ไม่สามารถย้อนกลับได้`;
      confirmModal.classList.remove('opacity-0','pointer-events-none');
      confirmModal.querySelector('.modal-content').classList.remove('scale-95');
    }
    function hideConfirmModal() {
      userToDeleteId = null;
      confirmModal.classList.add('opacity-0','pointer-events-none');
      confirmModal.querySelector('.modal-content').classList.add('scale-95');
    }
    confirmModalCancel.addEventListener('click', hideConfirmModal);
    confirmModalDelete.addEventListener('click', async () => {
      if (!userToDeleteId) return; 
      try{
        await deleteDoc(doc(db, `artifacts/${appId}/public/data/employees`, userToDeleteId));
        hideConfirmModal();
        await fetchRegisteredUsers();
        await loadRegisteredUsersForRecognition();
      }catch(err){ showModal('เกิดข้อผิดพลาด', 'ไม่สามารถลบผู้ใช้ได้', true); }
    });

    // --- Helpers ---
    function updateClock(){
      const now = new Date();
      clockTime.textContent = now.toLocaleTimeString('th-TH', { hour12:false });
    }

    function showPinForm(show){
      pinContainer.classList.toggle('hidden', !show);
      clockContainer.classList.toggle('hidden', show);
    }
    pinFallbackButton.addEventListener('click', ()=> showPinForm(true));
    pinCancelButton.addEventListener('click', ()=> showPinForm(false));

    async function loadModels(){
      const candidates = [
        './models',
        'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights',
        'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'
      ];
      for (const src of candidates){
        try{
          await faceapi.nets.tinyFaceDetector.loadFromUri(src);
          await faceapi.nets.ssdMobilenetv1.loadFromUri(src);
          await faceapi.nets.faceLandmark68Net.loadFromUri(src);
          await faceapi.nets.faceRecognitionNet.loadFromUri(src);
          return true;
        } catch(e){ console.warn('[models] source failed:', src, e); }
      }
      const msg = 'เกิดข้อผิดพลาดในการโหลดโมเดล AI<br>กรุณารีเฟรชหรือลองใหม่';
      if (loader) loader.innerHTML = `<p class="text-red-500">${msg}</p>`;
      if (clockLoader) clockLoader.innerHTML = `<p class="text-red-500">${msg}</p>`;
      return false;
    }

    // --- Webcam ---
    async function startWebcam(videoElement, callback){
      if (!videoElement || videoElement.srcObject) return;
      try{
        const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
        if (!isSecure){
          showModal('ต้องเปิดผ่าน HTTPS', 'การใช้งานกล้องต้องเปิดผ่าน HTTPS หรือ localhost', true);
          return;
        }
        const constraints = { video: { facingMode: 'user', width: {ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.setAttribute('playsinline','true');
        videoElement.muted = true;
        videoElement.srcObject = stream;
        videoElement.addEventListener('loadedmetadata', () => {
          if (videoElement.id === 'video'){
            captureButton.disabled = false;
            statusMessage.textContent = 'กรุณาจัดใบหน้าให้อยู่ในกรอบ';
          }
          if (callback) callback();
        }, { once:true });
      }catch(err){
        console.error('Error accessing webcam:', err);
        const msg = 'ไม่สามารถเข้าถึงกล้องได้ (โปรดเช็คสิทธิ์การใช้งานกล้องในเบราว์เซอร์)';
        if (videoElement.id === 'video') statusMessage.textContent = msg;
        else showModal('ข้อผิดพลาด', msg, true);
      }
    } });
        videoElement.srcObject = stream;
        videoElement.addEventListener('loadedmetadata', () => {
          if (videoElement.id === 'video'){
            captureButton.disabled = false;
            statusMessage.textContent = 'กรุณาจัดใบหน้าให้อยู่ในกรอบ';
          }
          if (callback) callback();
        });
      }catch(err){
        console.error('Error accessing webcam:', err);
        const msg = 'ไม่สามารถเข้าถึงกล้องได้';
        if (videoElement.id === 'video') statusMessage.textContent = msg;
        else showModal('ข้อผิดพลาด', msg, true);
      }
    }
    function stopWebcam(videoElement){
      if (videoElement && videoElement.srcObject){
        videoElement.srcObject.getTracks().forEach(t=>t.stop());
        videoElement.srcObject = null;
      }
    }

    // --- Recognition ---
    async function loadRegisteredUsersForRecognition(){
      const q = query(collection(db, `artifacts/${appId}/public/data/employees`));
      const querySnapshot = await getDocs(q);
      registeredUsersData = [];
      querySnapshot.forEach(docSnap=>{
        const d = docSnap.data();
        if (Array.isArray(d.descriptor)) registeredUsersData.push({ id:d.id, name:d.name, descriptor:new Float32Array(d.descriptor) });
      });
      const labeled = registeredUsersData.map(u=> new faceapi.LabeledFaceDescriptors(u.id, [u.descriptor]));
      faceMatcher = labeled.length > 0 ? new faceapi.FaceMatcher(labeled, 0.6) : null;
    }

    async function fetchRegisteredUsers(){
      const q = query(collection(db, `artifacts/${appId}/public/data/employees`));
      onSnapshot(q, (snapshot)=>{
        const users = [];
        snapshot.forEach(docSnap=>{
          const d = docSnap.data();
          users.push(d);
        });
        userList.innerHTML = users.map(u=>
          `<div class="flex items-center justify-between p-2 bg-white rounded border">
            <div>
              <div class="font-medium">${u.name} <span class="text-gray-500 text-xs">(${u.id})</span></div>
              <div class="text-xs text-gray-500">PIN: ${u.pin || '-'}</div>
            </div>
            <button data-id="${u.id}" data-name="${u.name}" class="delete-user px-2 py-1 text-xs rounded bg-red-50 text-red-600">ลบ</button>
          </div>`).join('');
        userList.querySelectorAll('.delete-user').forEach(btn=> btn.addEventListener('click', ()=> showConfirmModal(btn.dataset.id, btn.dataset.name)) );
      });
    }

    function startRecognition(){
      if (recognitionInterval || !faceMatcher) return;
      clockLoader.classList.add('hidden');
      clockContainer.classList.remove('hidden');

      recognitionInterval = setInterval(async ()=>{
        if (currentTab!=='clock' || !pinContainer.classList.contains('hidden') || confirmMode) return;
        const detections = await faceapi
          .detectAllFaces(clockVideo, new faceapi.SsdMobilenetv1Options())
          .withFaceLandmarks().withFaceDescriptors();

        const displaySize = { width: clockVideo.clientWidth, height: clockVideo.clientHeight };
        faceapi.matchDimensions(clockCanvas, displaySize);
        const resized = faceapi.resizeResults(detections, displaySize);
        clockCanvas.getContext('2d').clearRect(0,0,clockCanvas.width,clockCanvas.height);

        // v5.7: if no registered users yet, skip matching
        if (!faceMatcher){
          clockStatus.textContent = 'ยังไม่มีพนักงานที่ลงทะเบียน';
          clockActionButton.disabled = true;
          return;
        }

        if (detections && detections.length>0){
          const best = detections.map(d=> faceMatcher.findBestMatch(d.descriptor)).find(m=> m && m.label!=='unknown');
          if (best){
            const matched = registeredUsersData.find(u=> u.id===best.label);
            activeUser = matched ? { id: matched.id, name: matched.name } : null;
            if (activeUser){
              faceapi.draw.drawDetections(clockCanvas, resized);
              clockStatus.textContent = `ยินดีต้อนรับ, ${activeUser.name}`;
              clockStatus.classList.add('text-green-600');
              clockActionButton.disabled = false;
              clockActionButton.textContent = 'กดเพื่อบันทึกเวลา';

              // v5.7: auto-confirm when same match is stable for AUTO_HOLD_MS
              const __now = Date.now();
              if (lastMatchId === activeUser.id){
                if (!stableMatchSince) stableMatchSince = __now;
                if (!confirmMode && (__now - stableMatchSince >= AUTO_HOLD_MS)){
                  enterConfirmMode(activeUser);
                }
              } else {
                lastMatchId = activeUser.id;
                stableMatchSince = 0;
              }
            } else {
              // v5.7: reset stability when not confidently matched
              resetClockStatus();
              lastMatchId = null;
              stableMatchSince = 0;
            }
          } else resetClockStatus();
        } else resetClockStatus();
      }, 1000);
    }
    function stopRecognition(){ if (recognitionInterval){ clearInterval(recognitionInterval); recognitionInterval=null; } }
    function resetClockStatus(){
      activeUser=null; clockStatus.textContent=''; clockStatus.classList.remove('text-green-600');
      clockActionButton.disabled=true; clockActionButton.textContent='กรุณามองกล้องเพื่อสแกนใบหน้า';
    }

    // v5.7 confirm flow helpers
    function enterConfirmMode(user){
      confirmMode = true;
      confirmCandidate = user;
      confirmName.textContent = user && user.name ? `คุณ ${user.name}` : (user && user.id ? user.id : '-');
      confirmOverlay.classList.remove('hidden');
    }
    function exitConfirmMode(){
      confirmMode = false;
      confirmCandidate = null;
      stableMatchSince = 0;
      lastMatchId = null;
      confirmOverlay.classList.add('hidden');
    }
    function showSuccessOverlay(type){
      successText.textContent = type==='IN' ? 'บันทึกเข้างานสำเร็จ' : 'บันทึกออกงานสำเร็จ';
      successOverlay.classList.remove('hidden');
      setTimeout(()=>{
        successOverlay.classList.add('hidden');
        exitConfirmMode();
      }, 5000);
    }
    window.FORCED_ATTENDANCE_TYPE = null;
    window.suppressSuccessModal = false;
    function saveAttendanceWithType(type){
      if (!confirmCandidate) return;
      window.FORCED_ATTENDANCE_TYPE = type;
      window.suppressSuccessModal = true;
      recordAttendance(confirmCandidate, 'Face').finally(()=>{
        // success overlay will show after recordAttendance success
        window.suppressSuccessModal = false;
      });
    }
    if (confirmInBtn) confirmInBtn.addEventListener('click', async ()=>{
      saveAttendanceWithType('IN');
    });
    if (confirmOutBtn) confirmOutBtn.addEventListener('click', async ()=>{
      saveAttendanceWithType('OUT');
    });

    clockActionButton.addEventListener('click', ()=>{ if (activeUser) recordAttendance(activeUser,'Face'); });

    async function recordAttendance(user, method){
      const now = new Date();
      const lastScan = lastScanTimestamps[user.id];
      if (lastScan && (now - lastScan)/1000 < SCAN_COOLDOWN_SECONDS){
        showModal('สแกนซ้ำ', `กรุณารอ ${SCAN_COOLDOWN_SECONDS} วินาที`, true);
        return;
      }
      try{
        const todayStr = now.toISOString().split('T')[0];
        const startOfDay = new Date(todayStr).getTime();
        const endOfDay = startOfDay + 24*60*60*1000 - 1;

        const q = query(collection(db, `artifacts/${appId}/public/data/attendance`), where('employeeId','==',user.id));
        const querySnapshot = await getDocs(q);
        let todays = 0;
        querySnapshot.forEach(docSnap=>{
          const t = docSnap.data().timestamp.toDate().getTime();
          if (t>=startOfDay && t<=endOfDay) todays++;
        });

        const attendanceType = (window.FORCED_ATTENDANCE_TYPE && (window.FORCED_ATTENDANCE_TYPE==='IN' || window.FORCED_ATTENDANCE_TYPE==='OUT')) ? window.FORCED_ATTENDANCE_TYPE : (todays % 2 === 0 ? 'IN' : 'OUT');
        window.FORCED_ATTENDANCE_TYPE = null;
        const typeText = attendanceType==='IN' ? 'เข้างาน' : 'ออกงาน';

        await setDoc(doc(collection(db, `artifacts/${appId}/public/data/attendance`)), {
          employeeId: user.id, employeeName: user.name, timestamp: now, type: attendanceType, method
        });

        lastScanTimestamps[user.id] = now;
        if (window.suppressSuccessModal){ showSuccessOverlay(attendanceType); } else { showModal('บันทึกสำเร็จ', `คุณ ${user.name} ได้บันทึกเวลา${typeText}เรียบร้อยแล้ว`); }
        resetClockStatus();
        await fetchRecentAttendance();
      }catch(err){
        console.error('Error recording attendance:', err);
        showModal('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกเวลาได้', true);
      }
    }

    async function fetchRecentAttendance(){
      try{
        const q = query(collection(db, `artifacts/${appId}/public/data/attendance`));
        const querySnapshot = await getDocs(q);
        const items = [];
        querySnapshot.forEach(docSnap=>{
          const d = docSnap.data();
          items.push(d);
        });
        items.sort((a,b)=> b.timestamp.toDate()-a.timestamp.toDate());
        recentAttendanceList.innerHTML = items.slice(0,5).map(it=>{
          const t = it.timestamp.toDate();
          const dateStr = t.toLocaleString('th-TH', { hour12:false });
          return `<div class="flex items-center justify-between p-2 bg-white rounded border">
            <div>
              <div class="font-medium">${it.employeeName} <span class="text-gray-500 text-xs">(${it.employeeId})</span></div>
              <div class="text-xs text-gray-500">${dateStr}</div>
            </div>
            <span class="text-xs px-2 py-1 rounded ${it.type==='IN'?'bg-green-100 text-green-700':'bg-amber-100 text-amber-700'}">${it.type}</span>
          </div>`;
        }).join('');
      }catch(err){ console.error('recent error', err); }
    }

    // --- Register flow ---
    const TOTAL_CAPTURES = 3;
    let capturedDescriptors = [];

    captureButton.addEventListener('click', async ()=>{
      if (capturedDescriptors.length >= TOTAL_CAPTURES) return;
      statusMessage.textContent = 'กำลังประมวลผล...';
      const detection = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320 }))
        .withFaceLandmarks().withFaceDescriptor();
      if (!detection){ statusMessage.textContent = 'ไม่พบใบหน้า ลองใหม่'; return; }
      const displaySize = { width: video.clientWidth, height: video.clientHeight };
      faceapi.matchDimensions(regCanvas, displaySize);
    });

    saveButton.addEventListener('click', async ()=>{
      const id = employeeIdInput.value.trim();
      const name = employeeNameInput.value.trim();
      const pin = employeePinInput.value.trim();
      if (!id || !name || !pin || capturedDescriptors.length < TOTAL_CAPTURES){ showModal('ข้อมูลไม่ครบ', 'กรุณากรอกข้อมูลและถ่ายใบหน้าให้ครบ', true); return; }
      const avg = new Float32Array(capturedDescriptors[0].length);
      capturedDescriptors.forEach(desc=> desc.forEach((v,i)=> avg[i]+=v));
      for(let i=0;i<avg.length;i++) avg[i]/=capturedDescriptors.length;
      try{
        await setDoc(doc(db, `artifacts/${appId}/public/data/employees`, id), { id, name, pin, descriptor: Array.from(avg) });
        showModal('บันทึกสำเร็จ','ลงทะเบียนพนักงานเรียบร้อยแล้ว');
        capturedDescriptors = [];
        employeeIdInput.value=''; employeeNameInput.value=''; employeePinInput.value='';
        thumbnailsContainer.innerHTML='';
        await loadRegisteredUsersForRecognition();
      }catch(err){ showModal('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้', true); }
    });

    // --- History ---
    function renderHistory(rows){
      const dateFilter = historyDateInput.value; const q = historySearchInput.value.toLowerCase();
      const rows2 = rows.filter(r=>{
        const dateMatch = !dateFilter || r.date === dateFilter;
        const searchMatch = !q || r.employeeName.toLowerCase().includes(q) || r.employeeId.toLowerCase().includes(q);
        return dateMatch && searchMatch;
      });

      historyTableBody.innerHTML=''; 
      historyNoData.classList.toggle('hidden', rows2.length>0);
      historyTableBody.classList.toggle('hidden', rows2.length===0);

      rows2.forEach(d=>{
        d.records.sort((a,b)=>a-b);
        const clockIn = d.records[0];
        const clockOut = d.records.length>1 ? d.records[d.records.length-1] : null;
        let hoursWorked = '-';
        if (clockIn && clockOut) hoursWorked = ((clockOut - clockIn)/36e5).toFixed(2);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-2">${d.employeeName} <span class="text-xs text-gray-500">(${d.employeeId})</span></td>
          <td class="px-4 py-2">${d.date}</td>
          <td class="px-4 py-2">${clockIn? new Date(clockIn).toLocaleTimeString('th-TH',{hour12:false}) : '-'}</td>
          <td class="px-4 py-2">${clockOut? new Date(clockOut).toLocaleTimeString('th-TH',{hour12:false}) : '-'}</td>
          <td class="px-4 py-2">${hoursWorked}</td>`;
        historyTableBody.appendChild(tr);
      });
    }

    exportCsvButton.addEventListener('click', ()=>{
      // Minimal: keep as-is or implement existing behavior elsewhere
      showModal('Export CSV', 'ฟังก์ชันนี้พร้อมใช้งานตามเวอร์ชันเดิม');
    });

    historyDateInput.addEventListener('change', ()=> renderHistory(fullHistoryData));
    historySearchInput.addEventListener('input', ()=> renderHistory(fullHistoryData));

    // --- Tab switcher ---
    function switchTab(tabName){
      currentTab = tabName;
      Object.keys(tabs).forEach(key => {
        tabs[key].classList.toggle('text-indigo-600', key===tabName);
        tabs[key].classList.toggle('border-b-2', key===tabName);
        tabs[key].classList.toggle('border-indigo-500', key===tabName);
        tabs[key].classList.toggle('text-gray-500', key!==tabName);
        contents[key].classList.toggle('hidden', key!==tabName);
      });

      if (tabName==='clock'){
        stopWebcam(video);
        startWebcam(clockVideo, () => startRecognition());
        showPinForm(false);
      } else if (tabName==='register') {
        stopWebcam(clockVideo); stopRecognition();
        startWebcam(video);
      } else {
        stopWebcam(video); stopWebcam(clockVideo); stopRecognition();
      }
    }
    Object.keys(tabs).forEach(key => tabs[key].addEventListener('click', () => switchTab(key)));

    // --- Face-API model loading (with fallbacks) ---
    async function trySource(MODEL_URL){
      if(!window.faceapi) throw new Error('face-api.js not loaded');
      console.log('[models] probing:', MODEL_URL);

      const ping = await fetch(`${MODEL_URL}/tiny_face_detector_model-weights_manifest.json`, { cache:'reload' });
      if (!ping.ok) throw new Error(`manifest 404 at ${MODEL_URL}`);

      const sequence = [
        ['tinyFaceDetector', () => faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL)],
        ['ssdMobilenetv1', () => faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)],
        ['faceLandmark68Net', () => faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)],
        ['faceRecognitionNet', () => faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)],
      ];

      for (const [name, loader] of sequence){
        try { await loader(); console.log('[models] loaded:', name); }
        catch{ throw new Error(`failed at ${name}`); }
      }
      return true;
    }

    async function ensureModels(){
      const candidates = ['./models','https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights','https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'];
      for (const src of candidates){
        try{ await trySource(src); return true; }
        catch(e){ console.warn('[models] source failed:', src, e); }
      }
      const msg = 'เกิดข้อผิดพลาดในการโหลดโมเดล AI<br>กรุณารีเฟรชหรือลองใหม่';
      if (loader) loader.innerHTML = '<p class="text-red-500">'+msg+'</p>';
      if (clockLoader) clockLoader.innerHTML = '<p class="text-red-500">'+msg+'</p>';
      return false;
    }

    // --- Main ---
    async function main(){
      try{
        await signInAnonymously(auth);
        const ok = await ensureModels();
        if (ok){
          await Promise.all([fetchRegisteredUsers(), loadRegisteredUsersForRecognition(), fetchRecentAttendance()]);
          loader.classList.add('hidden');
          registerFormContainer.classList.remove('hidden');
          historyDateInput.value = new Date().toISOString().split('T')[0];
          switchTab('clock');
          setInterval(updateClock, 1000);
        }
      }catch(err){
        console.error('Initialization failed:', err);
        loader.innerHTML = '<p class="text-red-500">เกิดข้อผิดพลาดในการเริ่มต้นระบบ</p>';
      }
    }
    main();
  </script>
</body>
</html>
