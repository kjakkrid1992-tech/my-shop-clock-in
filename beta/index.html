<!DOCTYPE html>
<html lang="th">
<head>
  <!--
    Version: v5.6.1 — First working build + 7 fixes
    Date: 2025-08-21 (Asia/Bangkok)
    Notes:
      - [1] Shift-aware suggestion + confirm
      - [2] Anti-duplicate within 3 minutes
      - [3] Warn if yesterday left IN (flag note)
      - [4] Server timestamp + Thai day cutoff
      - [5] One-hand bottom bar + video max-height
      - [6] Default tab=clock (+ ?tab=)
      - [7] Front camera + mirrored preview
    Deploy: rename this file to index.html at repo root (GitHub Pages), include ./models/
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Face Attendance — v5.6.1 (First working build + 7 fixes)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    :root { --pad: 14px; --radius: 14px; }
    html, body { height: 100%; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Kanit', sans-serif; background:#0b0b0e; color:#f5f5f7; }
    header { padding: var(--pad); display:flex; align-items:center; justify-content:space-between; gap:10px; }
    h1 { font-size: 16px; margin:0; opacity:.9; }

    /* Tabs */
    .tabs { display:flex; gap:8px; }
    .tab { border:1px solid #2a2a2e; padding:8px 12px; border-radius:999px; font-weight:700; opacity:.85; cursor:pointer; }
    .tab.active { background:#1b1b20; border-color:#36363b; }

    /* Video area */
    #clock-video-container {
      position: relative; width: 100%; max-width: 480px; margin: 0 auto; border-radius: var(--radius); overflow: hidden;
      aspect-ratio: 3 / 4; max-height: 60vh; background:#111;
    }
    #clockVideo, #clockCanvas { position:absolute; inset:0; width:100%; height:100%; object-fit: cover; }
    /* 7) Mirrored preview */
    video { transform: scaleX(-1); }

    /* 5) One-hand bottom bar */
    main { min-height: 100vh; position: relative; padding-bottom: 124px; }
    .clock-bottom-bar{
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 12px calc(16px + env(safe-area-inset-right)) calc(12px + env(safe-area-inset-bottom)) calc(16px + env(safe-area-inset-left));
      background: rgba(18,18,20,0.9); backdrop-filter: blur(8px); border-top:1px solid #242428;
      display: none; grid-template-columns: 1fr; gap: 10px; z-index: 50;
    }
    .clock-bottom-bar .primary{
      width: 100%; padding: 14px 18px; border-radius: 999px; font-size: 18px; font-weight: 800; color:#0b0b0e; background:#22c55e;
    }
    .clock-bottom-bar .row{ display:flex; gap:8px; }
    .clock-bottom-bar .ghost{ flex:1; padding:12px; border-radius: 999px; border:1px solid #2a2a2e; font-weight:700; background:#151518; color:#eaeaf0; }

    .card { border:1px solid #1e1e22; border-radius: var(--radius); background:#121216; padding: var(--pad); }
    .muted { color:#a5a7ae; }

    .badge { display:inline-flex; align-items:center; gap:6px; border:1px solid #2c2c32; border-radius: 999px; padding: 6px 10px; font-weight:700; }
    .badge.yellow { background:#2a2312; border-color:#463c22; color:#f6e3a1; }
    .badge.green { background:#0f2716; border-color:#16351f; color:#aef1c0; }
    .badge.red   { background:#2a1616; border-color:#4a2323; color:#f3b1b1; }

    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:96px; background:#1c1c20; color:#fff; border:1px solid #2a2a2e; border-radius:999px; padding:10px 14px; z-index:60; display:none; }

    /* Version badge */
    .version-badge{ position:fixed; top:10px; right:10px; z-index:70; font-size:12px; font-weight:800; padding:6px 10px; border-radius:999px; background:#11131a; border:1px solid #2a2a2e; color:#c9cbd3; opacity:.9; }
  </style>
</head>
<body>
  <header>
    <h1>Face Attendance — v5.6.1 · First working build + 7 fixes</h1>
    <nav class="tabs">
      <button id="tabClock" class="tab active" data-tab="clock">ลงเวลา</button>
      <button id="tabRegister" class="tab" data-tab="register">ลงทะเบียน</button>
      <button id="tabHistory" class="tab" data-tab="history">ประวัติ</button>
    </nav>
  </header>

  <div class="version-badge">v5.6.1</div>

  <main class="px-4 pb-6">
    <!-- CLOCK TAB -->
    <section id="clock" class="space-y-3">
      <div class="card space-y-3">
        <div class="flex items-center justify-between">
          <div id="shiftWarning" class="badge yellow" style="display:none">อยู่ระหว่างเปลี่ยนกะ (12:00–15:30)</div>
          <div id="clockStatus" class="badge">กำลังหาผู้ใช้…</div>
        </div>
        <div id="clock-video-container">
          <video id="clockVideo" autoplay muted playsinline></video>
          <canvas id="clockCanvas"></canvas>
        </div>
        <div class="grid gap-2">
          <div class="text-sm muted">พบ: <span id="activeUserName">—</span></div>
          <div class="text-sm muted">คำแนะนำ: <span id="suggestText">—</span></div>
        </div>
      </div>
      <div class="card">
        <div class="text-sm">รายการล่าสุด (วันนี้)</div>
        <ul id="todayList" class="mt-2 space-y-1 text-sm"></ul>
      </div>
    </section>

    <!-- REGISTER TAB (placeholder minimal) -->
    <section id="register" class="space-y-3 hidden">
      <div class="card">
        <div class="font-bold mb-2">ลงทะเบียนพนักงาน (ย่อ)</div>
        <div class="text-sm muted">*หน้านี้เป็น placeholder เพื่อให้ไฟล์ทำงานได้เดี่ยวๆ — โปรดใช้หน้าลงทะเบียนเดิมของคุณถ้ามี</div>
      </div>
    </section>

    <!-- HISTORY TAB (placeholder minimal) -->
    <section id="history" class="space-y-3 hidden">
      <div class="card">
        <div class="font-bold mb-2">ประวัติ (ย่อ)</div>
        <ul id="historyList" class="text-sm"></ul>
      </div>
    </section>
  </main>

  <!-- 5) One-hand bottom bar -->
  <div id="clock-bottom-bar" class="clock-bottom-bar">
    <button id="clockActionButton" class="primary" disabled>ยืนยันลงเวลา</button>
    <div class="row">
      <button id="notMeBtn" class="ghost">ไม่ใช่ฉัน</button>
      <button id="flipBtn" class="ghost">สลับกล้อง</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase + App -->
  <script type="module">
    // ===== Firebase init =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import {
      getFirestore, doc, setDoc, getDoc, deleteDoc, collection, getDocs, addDoc,
      query, where, orderBy, limit, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // === เติมคอนฟิกของโปรเจกต์คุณ (จากที่คุณให้ไว้) ===
    const firebaseConfig = {
      apiKey: "AIzaSyAzcUm26W9PdhiPpj0ivemX91MF_iEdMg8",
      authDomain: "face-attendance-app-d439d.firebaseapp.com",
      projectId: "face-attendance-app-d439d",
      storageBucket: "face-attendance-app-d439d.firebasestorage.app",
      messagingSenderId: "462584831921",
      appId: "1:462584831921:web:b1cbb6b7274533ce31e790"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = firebaseConfig.projectId; // ใช้ projectId เป็น appId

    await signInAnonymously(auth);

    // ====== UI helpers ======
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);

    function showToast(msg){
      const el = $('#toast'); el.textContent = msg; el.style.display='block';
      clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=> el.style.display='none', 2200);
    }

    function showClockBar(show=true){ $('#clock-bottom-bar').style.display = show ? 'grid' : 'none'; }

    function setBadge(el, text, color){
      el.textContent = text; el.className = 'badge' + (color?(' '+color):'');
    }

    // ====== Time helpers (4) server + Thai day ======
    function getBangkokNow(){
      const parts = new Intl.DateTimeFormat('sv-SE', { timeZone:'Asia/Bangkok', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' }).format(new Date());
      return new Date(parts.replace(' ', 'T') + '+07:00');
    }
    function getBangkokDayRange(date = new Date()){
      const dayKey = new Intl.DateTimeFormat('sv-SE',{ timeZone:'Asia/Bangkok', year:'numeric', month:'2-digit', day:'2-digit' }).format(date);
      const startOfDay = Date.parse(`${dayKey}T00:00:00+07:00`);
      const endOfDay   = Date.parse(`${dayKey}T23:59:59.999+07:00`);
      return { startOfDay, endOfDay, dayKey };
    }
    function sameThaiDay(ts1, ts2){
      const f = (d)=> new Intl.DateTimeFormat('sv-SE',{ timeZone:'Asia/Bangkok', year:'numeric', month:'2-digit', day:'2-digit'}).format(d);
      return f(ts1) === f(ts2);
    }

    // ====== (1) Suggest IN/OUT with confirmation ======
    function suggestTypeForNow(lastTypeToday){
      if (!lastTypeToday) return 'IN';
      return lastTypeToday === 'IN' ? 'OUT' : 'IN';
    }

    function isShiftOverlapNow(){
      const now = getBangkokNow();
      const min = now.getHours()*60 + now.getMinutes();
      return (min >= 12*60 && min <= 15*60+30); // 12:00–15:30
    }

    // ====== (2) Anti duplicate within 3 minutes ======
    const MIN_GAP_MS = 3 * 60 * 1000;
    async function canRecord(employeeId){
      const qy = query(
        collection(db, `artifacts/${appId}/public/data/attendance`),
        where('employeeId', '==', employeeId),
        orderBy('timestamp','desc'),
        limit(1)
      );
      const snap = await getDocs(qy);
      if (snap.empty) return true;
      const last = snap.docs[0].data();
      const lastMs = last.timestamp?.toMillis?.() ?? new Date(last.timestamp).getTime();
      const nowMs  = getBangkokNow().getTime();
      return (nowMs - lastMs) >= MIN_GAP_MS;
    }

    // (3) Warn if yesterday left open IN
    async function warnIfYesterdayOpenIN(employeeId){
      const qy = query(
        collection(db, `artifacts/${appId}/public/data/attendance`),
        where('employeeId','==',employeeId),
        orderBy('timestamp','desc'),
        limit(1)
      );
      const snap = await getDocs(qy);
      if (snap.empty) return false;
      const last = snap.docs[0].data();
      const lastAt = last.timestamp?.toDate?.() ?? new Date(last.timestamp);
      const now = getBangkokNow();
      if (last.type === 'IN' && !sameThaiDay(lastAt, now)){
        showToast('เตือน: เมื่อวานยังไม่ได้ออกงาน');
        window.__missingOutYesterday = true; return true;
      }
      return false;
    }

    async function getLastTypeToday(employeeId){
      const { startOfDay, endOfDay } = getBangkokDayRange(getBangkokNow());
      const qy = query(
        collection(db, `artifacts/${appId}/public/data/attendance`),
        where('employeeId','==',employeeId),
        orderBy('timestamp','desc'),
        limit(10)
      );
      const snap = await getDocs(qy);
      let lastType = null;
      snap.forEach(d=>{
        const row = d.data();
        const t = row.timestamp?.toMillis?.() ?? new Date(row.timestamp).getTime();
        if (t >= startOfDay && t <= endOfDay && !lastType){ lastType = row.type; }
      });
      return lastType; // 'IN' | 'OUT' | null
    }

    async function recordAttendance(user, chosenType, method){
      if (!(await canRecord(user.id))){ showToast('เพิ่งลงเวลาไปไม่นาน กรุณารอ 3 นาที'); return; }
      await setDoc(doc(collection(db, `artifacts/${appId}/public/data/attendance`)), {
        employeeId: user.id,
        employeeName: user.name,
        type: chosenType,
        method,
        note: window.__missingOutYesterday ? 'yesterday_out_missing' : null,
        timestamp: serverTimestamp()
      });
      window.__missingOutYesterday = false;
      showToast('บันทึกสำเร็จ');
      await refreshTodayList(user.id);
    }

    // ====== Demo: load registered users (minimal) ======
    // คาดหวังคอลเลคชัน employees: { id, name }
    async function loadEmployees(){
      const arr = [];
      const snap = await getDocs(collection(db, `artifacts/${appId}/public/data/employees`));
      snap.forEach(d=> arr.push(d.data()));
      return arr; // [{id,name}]
    }

    // ====== Face recognition (minimal wire-up; ใช้โมเดล tiny) ======
    let stream, usingFront = true;
    async function startWebcam(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'user' }, width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} }, audio:false
        });
        $('#clockVideo').srcObject = stream;
      }catch(e){ setBadge($('#clockStatus'),'เปิดกล้องไม่ได้','red'); console.error(e); }
    }

    async function flipCamera(){
      try{
        usingFront = !usingFront;
        if (stream){ stream.getTracks().forEach(t=>t.stop()); }
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: usingFront ? 'user':'environment' }, width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} }
        });
        $('#clockVideo').srcObject = stream;
      }catch(e){ showToast('สลับกล้องไม่สำเร็จ'); console.error(e); }
    }

    // โหลดโมเดลจากโฟลเดอร์ ./models (ต้องมีไฟล์โมเดลในโปรเจกต์เดิมอยู่แล้ว)
    await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
    await faceapi.nets.faceLandmark68Net.loadFromUri('./models');
    await faceapi.nets.faceRecognitionNet.loadFromUri('./models');

    // ====== Recognition loop (placeholder matching by "employees[0]") ======
    // หมายเหตุ: ส่วนนี้เป็นโครงให้ผูกกับระบบ embeddings เดิมของคุณ
    const employees = await loadEmployees();
    let activeUser = null;
    window.activeUser = null;

    async function recognitionLoop(){
      const video = $('#clockVideo');
      const canvas = $('#clockCanvas');
      if (!video || video.readyState < 2){ requestAnimationFrame(recognitionLoop); return; }

      const dims = faceapi.matchDimensions(canvas, { width: video.videoWidth, height: video.videoHeight }, true);
      const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ scoreThreshold: 0.5 }))
                        .withFaceLandmarks().withFaceDescriptor();
      canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
      if (det){
        const resized = faceapi.resizeResults(det, dims);
        faceapi.draw.drawDetections(canvas, resized);
        // TODO: นำ descriptor ไปหาคนที่ใกล้สุดจากฐาน (faceMatcher)
        // ในที่นี้จะจำลองว่ารู้จักเป็นคนแรกของลิสต์ (เพื่อให้ปุ่มทำงานครบ flow)
        if (!activeUser && employees.length){ activeUser = employees[0]; window.activeUser = activeUser; }
      } else {
        activeUser = null; window.activeUser = null;
      }

      updateClockUi();
      requestAnimationFrame(recognitionLoop);
    }

    // ====== UI Clock behaviors ======
    async function updateClockUi(){
      const status = $('#clockStatus');
      const nameEl = $('#activeUserName');
      const suggestEl = $('#suggestText');
      const btn = $('#clockActionButton');

      // 5) show fixed bar only on clock tab
      showClockBar(currentTab === 'clock');

      // overlap banner
      $('#shiftWarning').style.display = isShiftOverlapNow() ? 'inline-flex' : 'none';

      if (activeUser){
        nameEl.textContent = `${activeUser.name} (${activeUser.id})`;
        setBadge(status, 'พบผู้ใช้', 'green');
        await warnIfYesterdayOpenIN(activeUser.id);
        const lastTypeToday = await getLastTypeToday(activeUser.id);
        const suggestion = suggestTypeForNow(lastTypeToday);
        suggestEl.textContent = suggestion === 'IN' ? 'เข้า' : 'ออก';
        btn.textContent = `ยืนยันลงเวลา: ${suggestion === 'IN' ? 'เข้า' : 'ออก'}`;
        btn.disabled = false;
      } else {
        nameEl.textContent = '—'; suggestEl.textContent = '—';
        setBadge(status, 'กำลังหาผู้ใช้…', '');
        btn.textContent = 'ยืนยันลงเวลา';
        btn.disabled = true;
      }

      // refresh today list for active user
      if (activeUser){ await refreshTodayList(activeUser.id); }
    }

    async function refreshTodayList(employeeId){
      const ul = $('#todayList');
      const { startOfDay, endOfDay } = getBangkokDayRange(getBangkokNow());
      const qy = query(
        collection(db, `artifacts/${appId}/public/data/attendance`),
        where('employeeId','==',employeeId),
        orderBy('timestamp','desc'),
        limit(20)
      );
      const snap = await getDocs(qy);
      ul.innerHTML = '';
      snap.forEach(d=>{
        const row = d.data();
        const t = row.timestamp?.toDate?.() ?? new Date(row.timestamp);
        const ms = row.timestamp?.toMillis?.() ?? new Date(row.timestamp).getTime();
        if (ms < startOfDay || ms > endOfDay) return;
        const li = document.createElement('li');
        li.textContent = `${row.type} • ${new Intl.DateTimeFormat('th-TH',{ hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone:'Asia/Bangkok' }).format(t)}${row.note?' • '+row.note:''}`;
        ul.appendChild(li);
      });
    }

    // ====== Tabs (6) default clock + ?tab= ======
    let currentTab = 'clock';
    function switchTab(tab){
      currentTab = tab;
      $$('#clock, #register, #history').forEach(el=> el.classList.add('hidden'));
      $(`#${tab}`).classList.remove('hidden');
      $$('.tab').forEach(b=> b.classList.remove('active'));
      $(`.tab[data-tab="${tab}"]`).classList.add('active');
      if (tab === 'clock'){ showClockBar(true); } else { showClockBar(false); }
    }

    const params = new URLSearchParams(location.search);
    const initialTab = params.get('tab') || 'clock';
    switchTab(initialTab);

    $$('.tab').forEach(btn=> btn.addEventListener('click', ()=> switchTab(btn.dataset.tab)));

    // ====== Events ======
    $('#flipBtn').addEventListener('click', flipCamera);
    $('#notMeBtn').addEventListener('click', ()=>{ activeUser = null; window.activeUser = null; updateClockUi(); });

    $('#clockActionButton').addEventListener('click', async ()=>{
      const btn = $('#clockActionButton');
      if (!activeUser || btn.disabled) return;
      btn.disabled = true; const prev = btn.textContent; btn.textContent = 'กำลังบันทึก…';
      try {
        const lastTypeToday = await getLastTypeToday(activeUser.id);
        const chosen = suggestTypeForNow(lastTypeToday);
        await recordAttendance(activeUser, chosen, 'Face');
      } catch (e){ console.error(e); showToast('บันทึกล้มเหลว'); }
      finally { btn.textContent = prev; setTimeout(()=> btn.disabled = false, 1500); }
    });

    // ====== Boot ======
    await startWebcam();
    recognitionLoop();
    updateClockUi();
  </script>
</body>
</html>

